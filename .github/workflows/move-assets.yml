name: Updated Move Assets to Release

permissions:
  contents: write
  actions: write
 
on:
  workflow_dispatch:
  workflow_run:
    workflows: ["build-macos.yml"] # This ensures `move-assets.yml` runs AFTER `build-macos.yml`
    types:
      - completed
  push:
    tags:
    - '*'

jobs:
  download_assets:
    runs-on: ubuntu-latest

    steps:
    - name: Extract tag name from ref
      id: get_tag
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          echo "Using tag: ${GITHUB_REF#refs/tags/}"
        else
          # If not triggered by tag, use a timestamp-based version
          TIMESTAMP=$(date +'%Y.%m.%d-%H%M')
          echo "TAG_NAME=v${TIMESTAMP}" >> $GITHUB_ENV
          echo "Not triggered by tag, using generated version: v${TIMESTAMP}"
        fi

    - name: Fetch Windows exe
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-windows.yml
        name: nlpw.exe

    - name: Fetch Windows icu1
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-windows.yml
        name: "icudt74.dll"

    - name: Fetch Windows icu2
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-windows.yml
        name: "icuuc74.dll"
        
    - name: Fetch Linux exe
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-linux.yml
        name: nlpl.exe
      
    - name: List Artifacts from MacOS Build
      run: |
        echo "🔍 Checking artifacts in build-macos.yml run..."
        LATEST_RUN_ID=$(gh api repos/${{ github.repository }}/actions/workflows/build-macos.yml/runs --paginate | jq -r '.workflow_runs[0].id')
        gh api repos/${{ github.repository }}/actions/runs/$LATEST_RUN_ID/artifacts --paginate | jq '.artifacts[].name'
        echo "LATEST_RUN_ID=$LATEST_RUN_ID" >> $GITHUB_ENV
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Fetch MacOS exe from Correct Run
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-macos.yml
        name: nlpm.exe
        run_id: ${{ env.LATEST_RUN_ID }}
    
    - name: Fetch Engine Files
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-enginefiles.yml
        name: "nlpengine.zip"

    - name: Fetch VisualText Files
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-visualfiles.yml
        name: "visualtext.zip"

    - name: Fetch Linux icu1
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-linux.yml
        name: "libicutu.a"

    - name: Fetch Linux icu2
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-linux.yml
        name: "libicuuc.a"
        
    - name: Fetch MacOS libicutum.a
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-macos.yml
        name: libicutum.a
        run_id: ${{ env.LATEST_RUN_ID }}

    - name: Fetch MacOS libicuucm.a
      uses: dawidd6/action-download-artifact@v8
      with:
        workflow: build-macos.yml
        name: libicuucm.a
        run_id: ${{ env.LATEST_RUN_ID }}

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: "Release ${{ env.TAG_NAME }}"
        body: "NLP Engine Release ${{ env.TAG_NAME }}"
        files: |
          ./nlpw.exe
          ./nlpl.exe
          ./nlpm.exe
          ./icudt74.dll
          ./icuuc74.dll
          ./libicutu.a
          ./libicuuc.a
          ./libicutum.a
          ./libicuucm.a
          ./nlpengine.zip
          ./visualtext.zip
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Trigger nlp-engine-windows workflow
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.CLASSIC_PAT }}
        repository: VisualText/nlp-engine-windows
        event-type: nlp-engine-release
        client-payload: '{"tag_name": "${{ env.TAG_NAME }}"}'
      continue-on-error: true

    - name: Trigger nlp-engine-linux workflow
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.CLASSIC_PAT }}
        repository: VisualText/nlp-engine-linux
        event-type: nlp-engine-release
        client-payload: '{"tag_name": "${{ env.TAG_NAME }}"}'
      continue-on-error: true

    - name: Trigger nlp-engine-mac workflow
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.CLASSIC_PAT }}
        repository: VisualText/nlp-engine-mac
        event-type: nlp-engine-release
        client-payload: '{"tag_name": "${{ env.TAG_NAME }}"}'
      continue-on-error: true